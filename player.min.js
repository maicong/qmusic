"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}(function(){var a=Math.round;window.FastClick.attach(document.body);var b,c={},d=window.$,e=d("#music-bgimg"),f=d("#music-radio"),g=d("#music-radios"),h=d("#music-pic"),i=d("#music-ctime"),j=d("#music-dtime"),k=d("#music-played"),l=d("#music-loaded"),m=d("#music-prev"),n=d("#music-play"),o=d("#music-next"),p=d("#music-volume"),q=d("#music-mute"),r=d("#music-showlist"),s=d("#music-view"),t=d("#music-list"),u=d("#music-detail"),v=d("#music-lrc"),w=d("#music-loading"),x=/*#__PURE__*/function(){function x(a,c){var e=this;_classCallCheck(this,x),this.settings=d.extend({songlist:[{songid:"",songmid:"",songname:"",albummid:"",albumname:"",singer:"",duration:"",vkey:""}],showlrc:!0,useRadio:!1,autoplay:!1,playIndex:0,cacheTime:86400,loop:"list",preload:"metadata"},c),this.total=this.settings.songlist.length,this.playIndex=this.settings.playIndex,this.cacheTime=this.settings.cacheTime,this.loadedTime=null,this.playTime=null,this.lrcTime=null,this.soundTime=null,this.playing=!1,this.ended=!1,this.radioId=0,this.storage=window.localStorage,this.support=!!document.createElement("audio").canPlayType("audio/mpeg"),this.isMobile=!!/(Android|webOS|Phone|iPad|iPod|BlackBerry|Windows Phone)/i.test(navigator.userAgent),this.radioUrl="".concat(document.URL,"?do=getRadios"),this.picUrl="https://qzonestyle.gtimg.cn/music/photo_new/T002R500x500M000{albummid}.jpg",this.lrcUrl="".concat(document.URL,"?do=getLrc&songid={songid}"),this.settings.useRadio?this._radio():this._init();var i=this;n.on("click",function(){b&&(d(this).hasClass("play")?i.trigger("play"):d(this).hasClass("pause")&&i.trigger("pause"))}),m.on("click",function(){b&&i.trigger("prev")}),o.on("click",function(){b&&i.trigger("next")}),q.on("click",function(){b&&(b.muted?(b.muted=!1,i._updateBar("volume",i.volume),d(this).removeClass("mute-off")):(b.muted=!0,i._updateBar("volume",0),d(this).addClass("mute-off")))}),t.on("click","li",function(){b&&(i.playIndex=d(this).index(),i.autoPlaying=!!i.playing,i.trigger("pause"),b.pause(),i._goto(d(this).index()))}),p.parent().on("click",function(a){if(b){var c=i._getOffsetX(a),e=d(this).width(),f=parseFloat(c/e).toFixed(2);b&&(i.volume=f,b.volume=f,i._storageSet("musicVolume",f),i._updateBar("volume",f))}}),k.parent().on("click",function(a){if(b){var c=i._getOffsetX(a),e=d(this).width(),f=parseFloat(c/e).toFixed(2);b&&(b.currentTime=f*b.duration,i._updateTime("ctime",f*b.duration),i._updateBar("played",f))}}),r.on("click",function(){b&&(641>d("body").width()&&(h.addClass("music__trans__left"),s.addClass("music__trans__none")),g.removeClass("view__active"),t.removeClass("view__hide").toggleClass("view__active"),u.removeClass("view__hide").toggleClass("view__active"))}),f.on("click",function(){641>d("body").width()?(h.toggleClass("music__trans__left"),s.toggleClass("music__trans__none"),t.addClass("view__hide"),u.addClass("view__hide"),g.addClass("view__active")):(t.toggleClass("view__hide"),u.toggleClass("view__hide"),g.toggleClass("view__active"))}),g.on("click","li",function(){var a=d(this).data("rid");d.isNumeric(a)&&(i.trigger("pause"),b.pause(),g.find("li").removeClass("playing"),d(this).addClass("playing"),i.radioId=a,i._storageSet("musicRadioId",a),i._getSongList(a,!0))}),window.Mousetrap.bind("space",function(){n.trigger("click")}),window.Mousetrap.bind("left",function(){b&&e.trigger("prev")}),window.Mousetrap.bind("right",function(){b&&e.trigger("next")})}return _createClass(x,[{key:"_init",value:function c(){var a=this._storageGet("musicPlayIndex");a&&(this.playIndex=a);var b=this.settings.songlist[this.playIndex];this._updateList(this.settings.songlist),b.songid&&b.songmid?this._goto(this.playIndex):1<this.total?(this.settings.songlist.splice(this.playIndex,this.playIndex+1),this.next()):this.error()}},{key:"_loading",value:function b(a){a?w.removeClass("loading__over"):(this.loadedTime&&clearTimeout(this.loadedTime),this.loadedTime=setTimeout(function(){w.addClass("loading__over")},500))}},{key:"_audio",value:function(a){var b,d,e=a.toString();return c[e]?b=c[e]:(b=document.createElement("audio"),a.forEach(function(a){d=document.createElement("source"),d.src=a,b.appendChild(d)}),c[e]=b),b}},{key:"_secondToTime",value:function e(a){var b=parseInt(a/60),c=parseInt(a-60*b),d=function(a){return 10>a?"0".concat(a):"".concat(a)};return"".concat(d(b),":").concat(d(c))}},{key:"_getOffsetX",value:function c(a){a=a||window.event;var b=a.target||a.srcElement;return a.offsetX||a.clientX-b.getBoundingClientRect().left}},{key:"_validTime",value:function b(a){return a&&a.hasOwnProperty("data")&&a.hasOwnProperty("timestamp")?a.timestamp+this.cacheTime>Date.parse(new Date)/1e3:void 0}},{key:"_parseLrc",value:function q(a){for(var b=a.split("\n"),c=b.length,d=null,e="",f="",g=[],h=0;h<c;h++)if(d=b[h].match(/\[(\d{2}):(\d{2})\.(\d{2,3})]/g),e=b[h].replace(/\[(\d{2}):(\d{2})\.(\d{2,3})]/g,"").replace(/^\s+|\s+$/g,""),null!=d)for(var k=d.length,l=0;l<k;l++){var m=/\[(\d{2}):(\d{2})\.(\d{2,3})]/.exec(d[l]),n=60*m[1]+parseInt(m[2])+parseInt(m[3])/(2==="".concat(m[3]).length?100:1e3);g.push([n,e])}g.sort(function(c,a){return c[0]-a[0]});for(var o=0;o<g.length;o++)if(g[o][1]){var p=0==o&&1<g.length?" class=\"active\"":"";f+="<p".concat(p," data-time=\"").concat(g[o][0],"\">").concat(g[o][1],"</p>")}v.html(f).fadeIn(200)}},{key:"_storageGet",value:function b(a){if(this.storage)return d.parseJSON(this.storage.getItem(a))}},{key:"_storageSet",value:function d(b,c){if(this.storage)return 1e3<a(JSON.stringify(this.storage).length/1024)&&this.storage.clear(),this.storage.setItem(b,JSON.stringify(c))}},{key:"_random",value:function c(a){var b=Math.floor;return a[b(Math.random()*a.length)]}},{key:"_fadeInSound",value:function e(a,b){var c=this,d=a.volume+.1;this.soundTime&&clearTimeout(this.soundTime),d<=this.volume&&(a.volume=d,this.soundTime=setTimeout(function(){c._fadeInSound(a,b)},b/10))}},{key:"_fadeOutSound",value:function e(a,b){var c=this,d=a.volume-.1;this.soundTime&&clearTimeout(this.soundTime),0<=d?(a.volume=d,this.soundTime=setTimeout(function(){c._fadeOutSound(a,b)},b/10)):a.pause()}},{key:"_updateInfo",value:function b(a){a=d.extend({songname:"\u6682\u65E0\u6B4C\u66F2\u540D",singer:"\u672A\u77E5",albumname:"\u672A\u77E5",pic:"/img/music-c513f7.jpg"},a),e.css({"background-image":"url(".concat(a.pic,")")}),h.find("img").attr("src",a.pic).fadeIn(200),u.find(".title").text(a.songname).attr("title",a.songname).fadeIn(200),u.find(".singer").text(a.singer).attr("title",a.singer).fadeIn(200),u.find(".album").text(a.albumname).attr("title",a.albumname).fadeIn(200),document.title="".concat(a.songname," - ").concat(a.singer," - \u97F3\u4E50\u542C")}},{key:"_updateList",value:function e(a){if(!d.isArray(a))return void this.trigger("error","(\u30FC\u30FC\u309B) \u65E0\u6548\u7684\u6B4C\u66F2\u5217\u8868");var b=this,c="<h3 class=\"title\">\u6B4C\u66F2\u5217\u8868 <small>(\u5171".concat(a.length,"\u9996)</small></h3><ul>");d.each(a,function(a,d){var e=d.songname,f=d.singer,g=d.duration;c+="<li><div class=\"name\" title=\"".concat(e,"\">").concat(e,"</div><div class=\"singer\" title=\"").concat(f,"\">").concat(f,"</div><div class=\"time\">").concat(b._secondToTime(g),"</div></li>")}),c+="</ul>",t.html(c)}},{key:"_updateRadios",value:function e(a){if(!d.isArray(a))return void this.trigger("error","(ToT)/ \u627E\u4E0D\u5230\u7535\u53F0");var b="",c=this._storageGet("musicRadioId");c||(c=a[0].rid,this._storageSet("musicRadioId",c)),this.radioId=c,d.each(a,function(a,c){var d=c.rid,e=c.pic,f=c.name;b+="<li data-rid=".concat(d,"><img src=\"").concat(e,"\"><p>").concat(f,"</p></li>")}),g.html(b),f.addClass("music__radio__on"),g.find("li[data-rid=\"".concat(c,"\"]")).addClass("playing"),this._getSongList(c)}},{key:"_updateTime",value:function c(a,b){b=d.isNumeric(b)?b:0,"ctime"===a&&i.html(this._secondToTime(b)),"dtime"===a&&j.html(this._secondToTime(b))}},{key:"_updateBar",value:function c(a,b){b=0<b?b:0,b=1>b?b:1,"played"===a&&k.css({width:"".concat(100*b,"%")}),"loaded"===a&&l.css({width:"".concat(100*b,"%")}),"volume"===a&&p.css({width:"".concat(100*b,"%")})}},{key:"_updateLrc",value:function c(a){var b=0;v.find("p").each(function(){a>=d(this).data("time")-.5&&(d(this).addClass("active").siblings("p").removeClass("active"),b+=d(this)[0].scrollHeight)}),v.parent().scrollTo({to:b,durTime:500})}},{key:"_goto",value:function i(a){"undefined"==typeof this.settings.songlist[a]&&(a=0),this._storageSet("musicPlayIndex",a),this.playIndex=a,this.ended=!1,this.radioId=this._storageGet("musicRadioId")||0;var c,e,f,g=this,h=this.settings.songlist[a];if(c=["M800","M500","C400","C200"].map(function(a){return"https://dl.stream.qqmusic.qq.com/".concat(a).concat(h.songmid,".mp3?vkey=").concat(h.vkey,"&guid=5150825362&fromtag=1")}),e=this.picUrl.replace("{albummid}",h.albummid),f=this.lrcUrl.replace("{songid}",h.songid),h.pic=e,b=this._audio(c),!this.support||!b)return void this.trigger("error","\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u652F\u6301 HTML5 \u97F3\u4E50\u64AD\u653E\u529F\u80FD");if(this._updateInfo(h),b.preload=this.settings.preload?this.settings.preload:"metadata",this.settings.showlrc){var j=this._storageGet("lrc_".concat(h.songid.toString()));this._validTime(j)?this._parseLrc(j.data):(this._loading(!0),d.getJSON(f,function(a){var b=a.data;b?(g._storageSet("lrc_".concat(h.songid.toString()),{data:b,timestamp:Date.parse(new Date)/1e3}),g._parseLrc(b)):g._parseLrc("[00:00.00]\u6682\u65E0\u6B4C\u8BCD\u4FE1\u606F"),g._loading(!1)}))}4===b.readyState&&(b.currentTime=0),this.isMobile&&g._loading(!1),(this.settings.autoplay||this.autoPlaying)&&this.trigger("play"),d(b).on("playing",function(){g.lrcTime&&clearInterval(g.lrcTime),g.settings.showlrc&&(g.lrcTime=setInterval(function(){g._updateLrc(b.currentTime)},1e3))}),d(b).on("pause",function(){g.lrcTime&&clearInterval(g.lrcTime)}),d(b).on("timeupdate",function(){g._updateTime("ctime",b.currentTime),g._updateBar("played",b.currentTime/b.duration)}),d(b).on("progress",function(){var a=b.buffered.length?b.buffered.end(b.buffered.length-1)/b.duration:0;g._updateBar("loaded",a)}),d(b).on("canplay",function(){var a=g._storageGet("musicVolume");a||(g._storageSet("musicVolume",.5),a=.5),g.volume=a,b.volume=a,g._loading(!1),g._updateBar("volume",a),g._updateTime("dtime",b.duration)}),d(b).on("error",function(){g.trigger("error")}),d(b).on("ended",function(){g.ended=!0,g.trigger("next")})}},{key:"_getSongList",value:function f(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],c=this,e=this._storageGet("musicList");this._validTime(e)&&!b?(this.settings.songlist=e.data,this.total=e.data.length,this._init()):(this._loading(!0),d.getJSON("".concat(this.radioUrl,"&rid=").concat(a),function(a){var b=a.data;b&&d.isArray(b)&&(c.settings.songlist=b,c.total=b.length,c._storageSet("musicList",{data:b,timestamp:Date.parse(new Date)/1e3}),c._init()),c._loading(!1)}))}},{key:"_radio",value:function c(){var a=this,b=this._storageGet("musicRadios");this._validTime(b)?this._updateRadios(b.data):(this._loading(!0),d.getJSON(this.radioUrl,function(b){var c=b.data;c&&d.isArray(c)?(a._storageSet("musicRadios",{data:c,timestamp:Date.parse(new Date)/1e3}),a._updateRadios(c)):a.trigger("error","\u256E\uFF08\u256F\uFF3F\u2570\uFF09\u256D \u7535\u53F0\u8F7D\u5165\u5931\u8D25"),a._loading(!1)}))}},{key:"play",value:function a(){this.playing||(this.playing=!0,n.removeClass("play").addClass("pause"),t.find("li").removeClass("playing"),t.find("li").eq(this.playIndex).addClass("playing"),q.addClass("mute-on"),b.volume=0,b.play(),this._fadeInSound(b,1e3))}},{key:"pause",value:function a(){(this.playing||this.ended)&&(this.playing=!1,this.ended=!1,this._fadeOutSound(b,1e3),n.removeClass("pause").addClass("play"),q.removeClass("mute-on"),this.isMobile&&b.pause())}},{key:"prev",value:function a(){this.playIndex--,0>this.playIndex&&(this.playIndex=this.total-1),this.autoPlaying=!!this.playing,this.trigger("pause"),b.pause(),this._goto(this.playIndex)}},{key:"next",value:function a(){return this.playIndex++,this.autoPlaying=!!this.playing,this.trigger("pause"),b.pause(),this.playIndex>=this.total&&(this.playIndex=0,d.isNumeric(this.radioId)&&1<this.radioId)?(this._storageSet("musicPlayIndex",0),void this._getSongList(this.radioId,!0)):void this._goto(this.playIndex)}},{key:"error",value:function b(a){this._updateInfo({songname:a||"(\xB0\u30FC\xB0\u3003) \u97F3\u4E50\u52A0\u8F7D\u5931\u8D25\u4E86"}),this.trigger("pause")}},{key:"trigger",value:function c(a,b){this[a](b)}}]),x}();d.fn.scrollTo=function(b){var c=d.extend({to:0,durTime:350,delay:10,callback:null},b),e=null,f=this,g=f.scrollTop(),h=c.to-g,i=0,j=a(c.durTime/c.delay),k=function(b){i++;var d=a(h/j);i>=j?(f.scrollTop(b),window.clearInterval(e),c.callback&&"function"==typeof c.callback&&c.callback()):f.scrollTop(g+i*d)};return e=window.setInterval(function(){k(c.to)},c.delay),f},d.fn.Player=function(a){return new x(this,a)},d("#music").Player({useRadio:!0,autoplay:!1}),window.Zepto=window.$=void 0})(window.Zepto);
